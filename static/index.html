
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Minecraft RL Hunter Zombies</title>
    <style>
        body { font-family: 'Consolas', monospace; background: #0d0d0d; color: #eee; text-align: center; }
        canvas { background: #1b261b; border: 4px solid #3e2723; margin-top: 10px; box-shadow: 0 0 30px rgba(0,0,0,0.7); }
        .panel { background: #212121; padding: 10px; display: inline-block; border: 1px solid #424242; border-radius: 8px; margin-bottom: 5px; min-width: 800px; }
        b { color: #ffca28; }
        .stat { margin: 0 10px; font-size: 14px; }
        .legend { font-size: 12px; color: #aaa; margin-top: 5px; }
        input[type=range] { vertical-align: middle; accent-color: #d84315; }
    </style>
</head>
<body>
    <div class="panel">
        <span class="stat">üß† Gen: <b id="gen">0</b></span> | 
        <span class="stat">üìÖ D√≠a: <b id="dia">1</b></span> | 
        <span class="stat">üíÄ Amenaza: <b id="threat" style="color:#ef5350">0</b>/10</span> |
        <span class="stat">üë• Vivos: <b id="pob">0</b></span> |
        <span class="stat">ü§ñ IQ: <b id="iq" style="color:#29b6f6">0</b></span>
        <br><br>
        <label>‚è© Velocidad:</label> <input type="range" id="slider" min="1" max="50" value="1">
    </div>

    <canvas id="simCanvas" width="1000" height="700"></canvas>

    <div class="legend">
        üî¥ Comida | üü§ Madera | ‚ö™ Piedra | 
        <span style="color:#ff9800">üè† Casa N1</span> -> <span style="color:#e65100">üè∞ Fortaleza N5</span> | 
        <span style="color:#00e676">üü© HP Alto</span> <span style="color:#ffea00">üü® HP Medio</span> <span style="color:#ff1744">üü• HP Cr√≠tico</span>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const ANCHO = 1000, ALTO = 700;

        function draw(data) {
            ctx.fillStyle = data.is_night ? "#0a0814" : "#2e7d32"; 
            ctx.fillRect(0, 0, ANCHO, ALTO);

            // Recursos
            data.recursos.forEach(r => {
                if(r.type === 'food') { 
                    ctx.fillStyle = '#ff1744'; ctx.beginPath(); ctx.arc(r.x, r.y, 4, 0, Math.PI*2); ctx.fill(); 
                } else {
                    ctx.fillStyle = (r.type === 'wood') ? '#795548' : '#bdbdbd'; 
                    ctx.fillRect(r.x-3, r.y-3, 7, 7);
                }
            });

            // Casas
            data.casas.forEach(h => {
                let size = 16 + (h.lvl * 6);
                if (h.lvl === 1) ctx.fillStyle = "#ff9800";
                else if (h.lvl === 2) ctx.fillStyle = "#e65100";
                else if (h.lvl === 3) ctx.fillStyle = "#d32f2f";
                else if (h.lvl === 4) ctx.fillStyle = "#7b1fa2";
                else ctx.fillStyle = "#212121";

                ctx.fillRect(h.x - size/2, h.y - size/2, size, size);

                // --- BARRA DE VIDA SEM√ÅFORO ---
                ctx.fillStyle = "black"; 
                ctx.fillRect(h.x - size/2, h.y - size/2 - 8, size, 5);

                let hp_pct = h.hp / h.max_hp;
                let hp_color = "#00e676"; // Verde
                if (hp_pct < 0.5) hp_color = "#ffea00"; // Amarillo
                if (hp_pct < 0.25) hp_color = "#ff1744"; // Rojo Alarma

                ctx.fillStyle = hp_color;
                ctx.fillRect(h.x - size/2, h.y - size/2 - 8, size * Math.max(0, hp_pct), 5);

                // Texto Capacidad
                ctx.fillStyle = "white"; ctx.font = "12px monospace";
                ctx.fillText(h.occupants + "/" + h.cap, h.x - 10, h.y + 5);
            });

            // Steves
            data.steves.forEach(p => {
                ctx.beginPath();
                ctx.fillStyle = "#29b6f6"; 
                ctx.arc(p.x, p.y, 6, 0, Math.PI*2);
                ctx.fill();

                ctx.fillStyle = "white"; ctx.font = "10px Arial";
                ctx.fillText(p.action, p.x - 10, p.y - 15);

                ctx.fillStyle = "red"; ctx.fillRect(p.x-6, p.y-9, 12, 2);
                ctx.fillStyle = "#76ff03"; ctx.fillRect(p.x-6, p.y-9, 12 * (p.hp/100), 2);
            });

            // Zombies
            data.zombies.forEach(z => {
                ctx.beginPath();
                ctx.fillStyle = "#1b5e20"; 
                ctx.arc(z.x, z.y, 7 + (z.tier * 2), 0, Math.PI*2);
                ctx.fill();
                ctx.strokeStyle = "red"; ctx.lineWidth = 1; ctx.stroke();
            });

            document.getElementById('dia').innerText = data.dia;
            document.getElementById('threat').innerText = data.difficulty;
            document.getElementById('pob').innerText = data.steves.length;
            document.getElementById('zom').innerText = data.zombies.length;
            document.getElementById('gen').innerText = data.gen;
            document.getElementById('iq').innerText = data.avg_iq.toFixed(0);
        }

        async function loop() {
            try {
                const response = await fetch('/data'); 
                if (response.ok) draw(await response.json());
            } catch(e) {}
            setTimeout(loop, 50); 
        }

        document.getElementById('slider').oninput = async function() {
            await fetch('/speed', { method: 'POST', body: JSON.stringify({val: this.value}) });
        };
        loop();
    </script>
</body>
</html>
